<?php

    public function toResponse(\Level3\Hal\ResourceBuilder $builder, \Mongator\Document\AbstractDocument $document)
    {
        $data = $this->collectDataForResponse($document);
        $builder->withData($this->types->toResponseArray($data));

{# referencesOne #}
{% for name in config_class.referencesOne|keys %}
        $referenced = $document->get{{ name|ucfirst }}();
        if ($referenced) {
            $builder->withLinkToResource('{{ name }}',
                '{{ extension.getResourceKey(config_class.referencesOne[name].class) }}', new \Level3\Messages\Parameters(['id' => $referenced->getId()]), (string) $referenced->getId()
            );
        }
{% endfor %}

{# referencesMany #}
{% for name in config_class.referencesMany|keys %}
        foreach ($document->get{{ name|ucfirst }}() as $relation) {
            $builder->withLinkToResource('{{ name }}',
                '{{ extension.getResourceKey(config_class.referencesMany[name].class) }}', new \Level3\Messages\Parameters(['id' => $relation->getId()]), (string) $relation->getId()
            );
        }

{% endfor %}

    

        return $builder->build();
    }

    protected function collectDataForResponse($document)
    {
        $data = $document->toArray();

{# embeddedsOne #}
{% for name in config_class.embeddedsOne|keys %}
        ${{ name }} = $document->get{{ name|ucfirst }}();
        if (!${{ name }}) {
            return null;
        }

        $data['{{ name }}'] = $this->types->toResponseArray(${{ name }}->toArray());

{% endfor %}
{# embeddedsMany #}
{% for name in config_class.embeddedsMany|keys %}
        ${{ name }} = [];
        foreach($document->get{{ name|ucfirst }}() as $elem) {
            ${{ name }}[] = $this->types->toResponseArray($elem->toArray());
        }

        $data['{{ name }}'] = ${{ name }};
{% endfor %}

        return $data;
    }

    public function fromRequest(Array $data)
    {
{% for name in config_class.fields|keys %}
{% if config_class.fields[name].type  == 'date' %}
        if (isset($data['{{ name }}'])) {
            $data['{{ name }}'] = $this->types->fromRequest('DateTime', $data['{{ name }}']);
        }
{% endif %}
{% endfor %}


{# referencesOne #}
{% for name in config_class.referencesOne|keys %}
        if (isset($data['{{ name }}'])) {
            $data['{{ name }}_reference_field'] = $this->types->fromRequest('MongoId', $data['{{ name }}']);
            unset($data['{{ name }}']);
        }
{% endfor %}

        return $data;
    }

